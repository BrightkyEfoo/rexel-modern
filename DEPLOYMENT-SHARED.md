# üöÄ D√©ploiement Partag√© - Frontend & Backend

Ce guide explique la nouvelle architecture de d√©ploiement o√π **Caddy** (reverse proxy) est centralis√© sur le backend et g√®re √† la fois le frontend et l'API.

## üìã Architecture

### Vue d'ensemble

```mermaid
flowchart TD
    Internet[üåê Internet]
    
    subgraph VPS[üñ•Ô∏è VPS - Ubuntu 22.04]
        subgraph Network[Docker Network: rexel-net]
            Caddy[üîÑ Caddy Reverse Proxy<br/>Backend Stack]
            Frontend[‚öõÔ∏è Frontend Container<br/>Next.js]
            Backend[üîß Backend Container<br/>AdonisJS]
            DB[üóÑÔ∏è PostgreSQL]
            MinIO[üì¶ MinIO Storage]
            Redis[‚ö° Redis Cache]
        end
    end
    
    Internet --> Caddy
    Caddy -->|kesimarket.com<br/>staging.kesimarket.com| Frontend
    Caddy -->|api.kesimarket.com<br/>staging-api.kesimarket.com| Backend
    Backend --> DB
    Backend --> MinIO
    Backend --> Redis
```

### Domaines configur√©s

| Environnement | Frontend | API |
|---------------|----------|-----|
| **Production** | `kesimarket.com` | `api.kesimarket.com` |
| **Staging** | `staging.kesimarket.com` | `staging-api.kesimarket.com` |

## üîß Configuration

### 1. R√©seau Docker Partag√©

Les deux applications utilisent le r√©seau Docker `rexel-net` :

```bash
# Cr√©ation du r√©seau (une seule fois)
docker network create rexel-net

# Ou utiliser le script automatique
./scripts/setup-docker-network.sh
```

### 2. Backend (avec Caddy)

Le backend inclut Caddy qui g√®re les deux applications :

```yaml
# rexel-modern-backend/docker-compose.prod.yml
networks:
  rexel-net:
    external: true

services:
  caddy:
    # G√®re TOUS les domaines
    # kesimarket.com ‚Üí frontend:3000
    # api.kesimarket.com ‚Üí app:3333
```

### 3. Frontend (sans Caddy)

Le frontend ne contient plus Caddy, juste l'application Next.js :

```yaml
# rexel-modern/docker-compose.prod.yml
networks:
  rexel-net:
    external: true

services:
  frontend:  # Nom important pour Caddy
    image: rexel-frontend-prod:latest
```

## üöÄ Workflow de D√©ploiement

### √âtape 1 : Setup initial (une seule fois)

```bash
# Sur le VPS
./scripts/setup-docker-network.sh
```

### √âtape 2 : D√©ploiement Backend

```bash
# Depuis GitHub Actions ou manuellement
cd ~/rexel-modern/backend
docker-compose -f docker-compose.prod.yml up -d
```

### √âtape 3 : D√©ploiement Frontend

```bash
# Depuis GitHub Actions ou manuellement  
cd ~/rexel-modern/frontend
docker-compose -f docker-compose.prod.yml up -d

# ‚ö†Ô∏è IMPORTANT: Red√©marrer Caddy pour d√©tecter le nouveau conteneur frontend
cd ~/rexel-modern/backend
docker restart rexel-caddy-prod
```

## üîÑ GitHub Actions

### Workflows modifi√©s

Les workflows GitHub Actions d√©ploient maintenant :

1. **Backend Workflow** (`rexel-modern-backend`)
   - Build l'image backend
   - D√©ploie avec Caddy
   - Configure tous les domaines

2. **Frontend Workflow** (`rexel-modern`)
   - Build l'image frontend  
   - D√©ploie sur le r√©seau partag√©
   - Se connecte automatiquement √† Caddy

### Variables secrets GitHub

```bash
# Backend (existantes)
VPS_HOST=your.vps.ip
VPS_USER=ubuntu
VPS_SSH_KEY=your_private_key

# Frontend (nouvelles)
VPS_HOST=your.vps.ip  
VPS_USER=ubuntu
VPS_SSH_KEY=your_private_key
```

## üìÅ Structure des dossiers VPS

```
~/rexel-modern/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ images/           # Images Docker backend
‚îÇ   ‚îú‚îÄ‚îÄ logs/            # Logs Caddy (tous domaines)
‚îÇ   ‚îú‚îÄ‚îÄ uploads/         # Fichiers application
‚îÇ   ‚îú‚îÄ‚îÄ minio-data/      # Stockage MinIO
‚îÇ   ‚îî‚îÄ‚îÄ backups/         # Sauvegardes DB
‚îî‚îÄ‚îÄ frontend/
    ‚îî‚îÄ‚îÄ images/          # Images Docker frontend
```

## ‚öôÔ∏è Variables d'environnement

### Production (rexel-modern/.env.production)

```bash
NEXT_PUBLIC_API_URL=https://api.kesimarket.com
NEXTAUTH_URL=https://kesimarket.com
NEXT_PUBLIC_SITE_URL=https://kesimarket.com
```

### Staging (rexel-modern/.env.staging)

```bash
NEXT_PUBLIC_API_URL=https://staging-api.kesimarket.com
NEXTAUTH_URL=https://staging.kesimarket.com
NEXT_PUBLIC_SITE_URL=https://staging.kesimarket.com
```

## üõ°Ô∏è S√©curit√© Caddy

### Features configur√©es

- ‚úÖ **SSL automatique** avec Let's Encrypt
- ‚úÖ **Rate limiting** diff√©rentiel (prod vs staging)
- ‚úÖ **Headers de s√©curit√©** complets
- ‚úÖ **CORS** configur√© par environnement
- ‚úÖ **Compression** Gzip/Brotli
- ‚úÖ **Logs s√©par√©s** par domaine

### Limits configur√©es

| Service | Production | Staging |
|---------|------------|---------|
| API g√©n√©rale | 100 req/min | 200 req/min |
| Upload fichiers | 10 req/min | 20 req/min |
| Taille upload | 50MB | 50MB |

## üîç Monitoring & Logs

### Logs Caddy

```bash
# Logs par domaine
~/rexel-modern/backend/logs/
‚îú‚îÄ‚îÄ frontend-access.log          # kesimarket.com
‚îú‚îÄ‚îÄ api-access.log              # api.kesimarket.com  
‚îú‚îÄ‚îÄ staging-frontend-access.log # staging.kesimarket.com
‚îî‚îÄ‚îÄ staging-api-access.log      # staging-api.kesimarket.com
```

### Health Checks

```bash
# Frontend
curl https://kesimarket.com
curl https://staging.kesimarket.com

# API
curl https://api.kesimarket.com/health
curl https://staging-api.kesimarket.com/health
```

## üêõ D√©pannage

### V√©rifier le r√©seau

```bash
docker network ls | grep rexel-net
docker network inspect rexel-net
```

### V√©rifier les conteneurs

```bash
# Backend stack (avec Caddy)
cd ~/rexel-modern/backend
docker-compose -f docker-compose.prod.yml ps

# Frontend
cd ~/rexel-modern/frontend  
docker-compose -f docker-compose.prod.yml ps
```

### V√©rifier la connectivit√©

```bash
# Depuis le conteneur Caddy
docker exec rexel-caddy-prod curl http://frontend:3000
docker exec rexel-caddy-prod curl http://app:3333/health
```

### Probl√®me : Network rexel-net not found

**Sympt√¥me** : `network rexel-net declared as external, but could not be found`

**Cause** : Le r√©seau partag√© n'existe pas encore sur le VPS

**Solution** : Cr√©er le r√©seau avant le d√©ploiement
```bash
# Option 1: Script automatique
cd ~/rexel-modern/backend
./scripts/setup-docker-network.sh

# Option 2: Commande manuelle
docker network create rexel-net

# V√©rifier
docker network ls | grep rexel-net
```

**Note** : Les workflows GitHub Actions cr√©ent automatiquement ce r√©seau, mais pour les d√©ploiements manuels il faut le cr√©er d'abord.

### Probl√®me : Network exists but verification failed

**Sympt√¥me** : 
```
out: ‚úÖ Network 'rexel-net' already exists
err: Error response from daemon: network rexel-net not found
out: ‚ùå Network verification failed
```

**Cause** : **Faux positif** dans la d√©tection - `grep` trouve quelque chose qui ressemble au r√©seau mais ce n'est pas le bon

**Solutions** :

#### 1. Script de nettoyage automatique (Recommand√©)
```bash
cd ~/rexel-modern/backend
chmod +x scripts/cleanup-network.sh
./scripts/cleanup-network.sh
```

#### 2. Nettoyage manuel
```bash
# Voir tous les r√©seaux
docker network ls

# Supprimer le r√©seau corrompu
docker network rm rexel-net --force

# Recr√©er proprement
docker network create rexel-net --driver bridge

# V√©rifier
docker network inspect rexel-net
```

#### 3. Reset complet Docker (en dernier recours)
```bash
# Arr√™ter tous les conteneurs rexel
docker stop $(docker ps -q -f name=rexel-) 2>/dev/null || true

# Nettoyer les r√©seaux
docker network prune -f

# Recr√©er le r√©seau
docker network create rexel-net --driver bridge
```

### Probl√®me : Database not ready / service "db" is not running

**Sympt√¥me** : 
```
out: Database not ready yet, waiting...
err: service "db" is not running
```

**Causes possibles** :
1. **Variables d'environnement manquantes** - Secrets GitHub non configur√©s
2. **Configuration incoh√©rente** - DB_HOST pointe vers service externe au lieu du conteneur interne
3. **Locales PostgreSQL** - Probl√®me avec les locales fran√ßaises sur Alpine Linux

**Solutions** :

#### 1. V√©rifier les secrets GitHub
Variables requises dans GitHub Secrets :
```bash
# Database
DB_USER=rexel_user
DB_PASSWORD=your_secure_password
DB_DATABASE=rexel_modern

# MinIO  
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=your_minio_secret_key
MINIO_BUCKET=rexel-storage

# Redis
REDIS_PASSWORD=your_redis_password

# Application
APP_KEY=your_32_character_secret_key
JWT_SECRET=your_jwt_secret_key
CORS_ORIGINS=https://kesimarket.com,https://staging.kesimarket.com
FRONTEND_URL=https://kesimarket.com
```

#### 2. Utiliser les services Docker internes
Dans le workflow, configurez :
```yaml
DB_HOST=db          # Pas d'IP externe
MINIO_HOST=minio    # Service interne
REDIS_HOST=redis    # Service interne
```

#### 3. V√©rification manuelle
```bash
# V√©rifier que PostgreSQL d√©marre
docker logs rexel-postgres-prod

# Tester la connexion
docker exec rexel-postgres-prod pg_isready -U your_user -d your_database

# V√©rifier les variables d'environnement
docker exec rexel-postgres-prod env | grep POSTGRES
```

### Probl√®me : Frontend pas accessible apr√®s d√©ploiement

**Sympt√¥me** : Le frontend ne r√©pond pas sur `kesimarket.com` ou `staging.kesimarket.com`

**Solution** : Red√©marrer Caddy apr√®s chaque d√©ploiement frontend
```bash
cd ~/rexel-modern/backend
docker restart rexel-caddy-prod

# V√©rifier que Caddy peut atteindre le frontend
docker exec rexel-caddy-prod curl -f http://frontend:3000
```

**Pourquoi ?** : Quand un nouveau conteneur frontend est cr√©√©, Caddy doit red√©marrer pour d√©tecter la nouvelle instance sur le r√©seau Docker.

### Logs en temps r√©el

```bash
# Caddy logs
docker logs -f rexel-caddy-prod

# Frontend logs
docker logs -f rexel-frontend-prod

# Backend logs  
docker logs -f rexel-backend-prod
```

## üéØ Avantages de cette architecture

‚úÖ **Un seul SSL** g√©r√© par Caddy  
‚úÖ **Configuration centralis√©e** des domaines  
‚úÖ **Rate limiting unifi√©**  
‚úÖ **Logs centralis√©s**  
‚úÖ **D√©ploiements ind√©pendants** (frontend/backend)  
‚úÖ **Scaling s√©par√©** possible  
‚úÖ **Maintenance simplifi√©e**

## üìö Liens utiles

- [Guide Caddy](./rexel-modern-backend/CADDY.md)
- [D√©ploiement Backend](./rexel-modern-backend/DEPLOYMENT.md)
- [Configuration GitHub Actions](./GITHUB-SETUP.md) 